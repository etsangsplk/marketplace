/**
 * @author Nikita Kolytschew
 * @version %I%, %G%
 * @since 1.0.0-SNAPSHOT
 */

import org.gradle.internal.os.OperatingSystem;

def final activeProfile = project.activeProfile

final def mainDir = "$projectDir/marketplace";

// start project
task startAngular2Project(type: Exec) {
	workingDir mainDir
	if (OperatingSystem.current().isWindows()) {
		commandLine 'cmd', '/c', 'ng serve'
	} else if (OperatingSystem.current().isUnix()) {
		commandLine 'ng serve'
	}
}

// delete dist dir
final def nodeJSMain = "$mainDir"
task angularClean(type: Delete) {
	// delete "${nodeJSMain}/node"
	delete "${nodeJSMain}/dist"
	// delete "${nodeJSMain}/node_modules"
}
clean.dependsOn(angularClean)

// run ng-build only on local builds
final def isLocal = project.hasProperty('local')
if (isLocal) {
	task buildAngular2(type: Exec) {
		workingDir mainDir
		if (activeProfile == 'prod') {
			if (OperatingSystem.current().isWindows()) {
				commandLine 'cmd', '/c', 'ng build -prod --aot'
			} else {
				println 'Todo: implement!\nExiting now!'
				System.exit(-1)
			}
		} else {
			if (OperatingSystem.current().isWindows()) {
				commandLine 'cmd', '/c', 'ng build -dev'
			} else {
				println 'Todo: implement!\nExiting now!'
				System.exit(-1)
			}
		}
	}
	build.dependsOn(buildAngular2)

	task copyGeneratedFiles(type: Copy) {
		final def mainSource = "$mainDir/dist/"
		final def mainDestination = "$rootDir/src/main/resources/public"
		copy {
			// first clean resources/public folder and remove old files
			delete "$mainDestination"
			// copy after
			into "$mainDestination"
			from "$mainSource"
		}
	}

}